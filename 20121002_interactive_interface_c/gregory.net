#!/bin/bash
##################
#
# this is some kind of wrapper, i dont know howto kill socat
# so i remove lockfile when quitting gregory
#
###################
################ when using bash I get the same pids ##########
MYPID=$BASHPID
MYPID2=$$

ALIVE=""
function ISALIVE() {
 ALIVE=`ps -e | grep $NEXTPID`
 if [ "$ALIVE" != "" ];then
     ALIVE=$ALIVE
#    echo "                socat is ALIVE result == $ALIVE"
 else
     ALIVE="pid DEAD"
#     echo "                socat is DEAD  result == $ALIVE"
 fi

}










#
TFILE="/tmp/$(basename $0).$$.tmp"
touch  $TFILE
echo $MYPID > $TFILE
echo "the lockfile for the socat is at  $TFILE"
echo mypid is $MYPID or $MYPID2


############# gregory option -rmlock is to remove the lock at the end
Process="./gregory -r $TFILE"
socat -d -d  EXEC:"$Process" TCP-LISTEN:11111,reuseaddr,fork,crlf &
NEXTPID=$!

echo . ================================================
echo  CONNECT WITH
echo  rlwrap nc localhost 11111
echo . ================================================
echo .
sleep 1

##$Process
# choose between on of both
PID=$(pgrep -f "$Process") # returns PID where command line matches
PID=$(pgrep -P $$ -f "$Process") # same as above but only whos PPID is the current script
########### I get the same PIDs ####################
echo "PGREP PID = $PID and socat pid is $NEXTPID"





################## trapping here ##############
realexit() 
{
   echo "int EXIT has done"
}

ctrlc() 
{       
   echo "int INT (ctrl-C)"
   echo "I must kil socat $NEXTPID"
   ISALIVE
   kill $NEXTPID
   echo "end this script"
   exit
}
        
##trap 'realexit' EXIT
trap 'ctrlc' INT 
###trap ':' HUP QUIT  # nop - do nothing - process continue





#socat EXEC:"kill $" TCP-LISTEN:11111,reuseaddr,fork,crlf
#
# co ted ? muzu removnout lock file a checkovat to tady
#
for (( i=0;i<1000;i++));do
 sleep 1
# ISALIVE
# if [ "$ALIVE" == "" ]; then
 if [ -e $TFILE ]; then
#     echo all is fine and file $TFILE exists `date`
     ISALIVE
     printf "\r%s %s"  `date +"%Y/%m/%d_%H:%M:%S"` " :: file $TFILE exists :: PID $ALIVE";
     else
     echo .... breaking ....
     break
 fi
done

#############testik jestli to facha.....
#read -p "press enter to quit the server" ANS
# if [ "$ANS" == "y" ]; then 
#  echo go go go
# fi
#ISALIVE

#################### real kill of this socat #######
echo killin $Process with pid $NEXTPID
kill $NEXTPID

#### this is removed from gregory rm $TFILE

#ISALIVE

